#!/bin/bash

DUT=../aycwabtu

KEYS=" \
000000000000 \
000000000001 \
000000000002 \
000000000003 \
000000000004 \
000000000005 \
000000000006 \
000000000007 \
000000000008 \
000000000009 \
00000000000A \
00000000000B \
00000000000C \
00000000000D \
00000000000E \
00000000000F \
000000000010 \
000000000011 \
000000000012 \
000000000013 \
000000000014 \
000000000015 \
000000000016 \
000000000017 \
000000000018 \
000000000019 \
00000000001A \
00000000001B \
00000000001C \
00000000001D \
00000000001E \
00000000001F \
000000000020 \
000000000021 \
000000000022 \
000000000023 \
000000000024 \
000000000025 \
000000000026 \
000000000027 \
000000000028 \
000000000029 \
00000000002A \
00000000002B \
00000000002C \
00000000002D \
00000000002E \
00000000002F \
000000000030 \
000000000031 \
000000000032 \
000000000033 \
000000000034 \
000000000035 \
000000000036 \
000000000037 \
000000000038 \
000000000039 \
00000000003A \
00000000003B \
00000000003C \
00000000003D \
00000000003E \
00000000003F \
000000000040 \
000000000041 \
000000000042 \
000000000043 \
000000000044 \
000000000045 \
000000000046 \
000000000047 \
000000000048 \
000000000049 \
00000000004A \
00000000004B \
00000000004C \
00000000004D \
00000000004E \
00000000004F \
000000000050 \
000000000051 \
000000000052 \
000000000053 \
000000000054 \
000000000055 \
000000000056 \
000000000057 \
000000000058 \
000000000059 \
00000000005A \
00000000005B \
00000000005C \
00000000005D \
00000000005E \
00000000005F \
000000000060 \
000000000061 \
000000000062 \
000000000063 \
000000000064 \
000000000065 \
000000000066 \
000000000067 \
000000000068 \
000000000069 \
00000000006A \
00000000006B \
00000000006C \
00000000006D \
00000000006E \
00000000006F \
000000000070 \
000000000071 \
000000000072 \
000000000073 \
000000000074 \
000000000075 \
000000000076 \
000000000077 \
000000000078 \
000000000079 \
00000000007A \
00000000007B \
00000000007C \
00000000007D \
00000000007E \
00000000007F \
000000000080 \
000000000081 \
000000000082 \
000000000083 \
000000000084 \
000000000085 \
000000000086 \
000000000087 \
000000000088 \
000000000089 \
00000000008A \
00000000008B \
00000000008C \
00000000008D \
00000000008E \
00000000008F \
000000000090 \
000000000091 \
000000000092 \
000000000093 \
000000000094 \
000000000095 \
000000000096 \
000000000097 \
000000000098 \
000000000099 \
00000000009A \
00000000009B \
00000000009C \
00000000009D \
00000000009E \
00000000009F \
0000000000A0 \
0000000000A1 \
0000000000A2 \
0000000000A3 \
0000000000A4 \
0000000000A5 \
0000000000A6 \
0000000000A7 \
0000000000A8 \
0000000000A9 \
0000000000AA \
0000000000AB \
0000000000AC \
0000000000AD \
0000000000AE \
0000000000AF \
0000000000B0 \
0000000000B1 \
0000000000B2 \
0000000000B3 \
0000000000B4 \
0000000000B5 \
0000000000B6 \
0000000000B7 \
0000000000B8 \
0000000000B9 \
0000000000BA \
0000000000BB \
0000000000BC \
0000000000BD \
0000000000BE \
0000000000BF \
0000000000C0 \
0000000000C1 \
0000000000C2 \
0000000000C3 \
0000000000C4 \
0000000000C5 \
0000000000C6 \
0000000000C7 \
0000000000C8 \
0000000000C9 \
0000000000CA \
0000000000CB \
0000000000CC \
0000000000CD \
0000000000CE \
0000000000CF \
0000000000D0 \
0000000000D1 \
0000000000D2 \
0000000000D3 \
0000000000D4 \
0000000000D5 \
0000000000D6 \
0000000000D7 \
0000000000D8 \
0000000000D9 \
0000000000DA \
0000000000DB \
0000000000DC \
0000000000DD \
0000000000DE \
0000000000DF \
0000000000E0 \
0000000000E1 \
0000000000E2 \
0000000000E3 \
0000000000E4 \
0000000000E5 \
0000000000E6 \
0000000000E7 \
0000000000E8 \
0000000000E9 \
0000000000EA \
0000000000EB \
0000000000EC \
0000000000ED \
0000000000EE \
0000000000EF \
0000000000F0 \
0000000000F1 \
0000000000F2 \
0000000000F3 \
0000000000F4 \
0000000000F5 \
0000000000F6 \
0000000000F7 \
0000000000F8 \
0000000000F9 \
0000000000FA \
0000000000FB \
0000000000FC \
0000000000FD \
0000000000FE \
0000000000FF \
000000000100 \
000000000101 \
FFFFFFFF0000 \
FFFFFFFFFFFF"

#aycwabtu has to throw error with these files
ERROR_TS=" \
aycwabtu_Testfile_adaptonly.ts                 \
aycwabtu_Testfile_adaptreserved.ts             \
aycwabtu_Testfile_decrypted.ts                 \
aycwabtu_Testfile_pid.ts                       \
aycwabtu_Testfile_pusi.ts                      \
aycwabtu_Testfile_size.ts                      \
aycwabtu_Testfile_sync.ts                      \
aycwabtu_Testfile_parity_change.ts             \
aycwabtu_Testfile_unencrypted.ts"


echo "--------- AYCWABTU test frame -----------"
echo " tested application:  $DUT"
echo " md5sum:              `md5sum $DUT`"
echo " git hash:            `git rev-parse HEAD`"
echo "if one test case hangs, test is failed"

echo ""
echo "checking faulty ts files"
for TS in $ERROR_TS
do
   echo -n "testing $TS ... "
	$DUT -t $TS >$TS.log
    if [ $? -lt 2 ] ; then echo "test failed with $?"; exit 1;fi; 
    rm $TS.log
   echo "ok"
done

echo ""
echo -n "testing adaptation field handling ... "
$DUT -t aycwabtu_Testfile_PID_123_CW_7FFAE9A02486.ts -a 7FFAE9900000 >aycwabtu_Testfile_PID_123_CW_7FFAE9A02486.log
if [ $? -ne 0 ] ; then echo "test failed with $?"; exit 1;fi; 
rm aycwabtu_Testfile_PID_123_CW_7FFAE9A02486.log
echo "ok"

echo ""
echo "checking if test keys are found in all batch slices"
for KEY in $KEYS
do
   echo -n "testing key $KEY ... "
	../tsgen testfile.ts $KEY
	$DUT -t testfile.ts -a $KEY >$KEY.log
    if [ $? -ne 0 ] ; then echo "test failed"; exit 1;fi; 
    rm $KEY.log
   echo "found!"
done

echo ""
echo "testframe finished successfully."
